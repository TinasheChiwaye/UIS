@model Funeral.Model.Search.MemberSearch
@{
    /**/

    ViewBag.Title = "My Policy";
    Layout = "~/Areas/Client/Views/Shared/_Layout.cshtml";
}
@Styles.Render("~/Content/datatablecss")
<script src="~/Scripts/plugins/dateformat/DateFormat.js"></script>  <!-- https://gist.github.com/eralston/968809 -->
@using (Html.BeginForm())
{
    <div class="dataTables_wrapper" id="tblMembersSearch_wrapper">
        <div class="col-lg-12">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>Members</h5>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-5">
                            <div class="form-group">
                                <label>Search:</label>
                                <div class="input-group">
                                    @Html.TextBoxFor(m => m.SarchText, null, new { @class = "form-control", @maxlength = "50", placeholder = "Search" })
                                    <span class="input-group-btn">
                                        <input type="button" id="btnSearch" value="Search" class="btn btn-w-m btn-primary" />
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <div class="form-group">
                                <label>Status: </label>
                                @Html.DropDownListFor(m => m.StatusId, new SelectList(ViewBag.Statuses, "Status", "Status"), "Select Status", new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="form-group">
                                <label>Show Entries:</label>
                                @Html.DropDownListFor(m => m.PageSize, new SelectList(ViewBag.EntriesCount, "Value", "Key"), new { @class = "form-control" })
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 ">
                            <div class="table-responsive">
                                @Html.EditorFor(model => model.PageNum, new { htmlAttributes = new { @class = "hidden", id = "PageNum1" } })
                                @Html.EditorFor(model => model.PageSize, new { htmlAttributes = new { @class = "hidden", id = "PageSize1" } })
                                <table id="memberDataTable" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Scheme</th>
                                            <th>Book </th>
                                            <th>ID Number</th>
                                            <th>Policy Number</th>
                                            @*<th>ID No</th>*@
                                            <th>Full Name</th>
                                            @*<th>Member</th>*@
                                            @*<th>EasyPayNo</th>
                                                <th>Cellphone</th>*@
                                            <th>Cover Date</th>
                                            <th>Policy Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var pkMemberId = null;
        $.noConflict();
        jQuery(document).ready(function ($) {
            var hasRight = '@ViewBag.HasAccess';
            if (hasRight == 'false') {
                var url = '@Url.Action("Error403", "Error", new { })';
                window.location.href = url;
            }
            else {
                $('#myModal').on('shown.bs.modal', function () {
                    $('#myInput').trigger('focus')
                })
                var jsdata = @Html.Raw(Json.Encode(Model));
                var statusId =@Html.Raw(Json.Encode(Model.StatusId));
                var companyId = @Html.Raw(Json.Encode(@Model.CompanyId));
                var sortOrder = @Html.Raw(Json.Encode(@Model.SortOrder));
                var sortBy =@Html.Raw(Json.Encode(@Model.SortBy));
                var totalRecord =@Html.Raw(Json.Encode(@Model.TotalRecord));
                var pageNum =@Html.Raw(Json.Encode(@Model.PageNum));
                var pageSize =@Html.Raw(Json.Encode(@Model.PageSize));
                var searchText =@Html.Raw(Json.Encode(@Model.SarchText));
                var bookId =@Html.Raw(Json.Encode(@Model.BookID));


                var model1 = {
                    StatusId: statusId,
                    CompanyId: companyId,
                    SortOrder: sortOrder,
                    SortBy: sortBy,
                    TotalRecord: totalRecord,
                    PageNum: pageNum,
                    PageSize: pageSize,
                    BookID: bookId,
                    SarchText: searchText

                };
                var datatable = $('#memberDataTable')
                    .on('page.dt', function () {
                        var table = $('#memberDataTable').DataTable();
                        var page = table.page.info();
                        model1.PageNum = page.page + 1;
                    })
                    .dataTable({
                        'bProcessing': true,
                        'bServerSide': true,
                        "bLengthChange": false,
                        'bFilter': false,
                        'scrollX': false,
                        "ordering": false,
                        "bSortable": false,
                        'ajax': {
                            "url": '@Url.Action("SearchData", "MyPolicy", null, Request.Url.Scheme)',
                            "type": "POST",
                            "contentType": "application/json",
                            "data": function (d) {
                                d['order'].forEach(function (item, index) {
                                    if (model1.SortBy != d['columns'][item.column]['data']) {
                                        model1.PageNum = 1;
                                        model1.SortOrder = "asc";
                                    }
                                    if (model1.SortBy == d['columns'][item.column]['data'] && model1.SortOrder != d['order'][index]['dir']) {
                                        model1.PageNum = 1;
                                        model1.SortOrder = d['order'][index]['dir'];
                                    }
                                    model1.SortBy = d['columns'][item.column]['data'];
                                    model1.SortOrder = d['order'][index]['dir'];
                                });
                                return JSON.stringify(model1);
                            },
                            "dataSrc": function (json) {

                                json.recordsTotal = json.TotalCount;
                                json.recordsFiltered = json.TotalCount;
                                json.data = json.Result;
                                var return_data = json;
                                return return_data.data;
                            }
                        },
                        "columns": [
                            //{ "data": "pkiMemberID", "name": "MemberId", "autoWidth": true, "visible": false },
                            { "data": "ApplicationName", "name": "Scheme", "autoWidth": true },
                            { "data": "MemberSociety", "name": "Book Name", "autoWidth": true },
                            { "data": "IDNumber", "name": "ID No", "autoWidth": true },
                            { "data": "MemeberNumber", "name": "Policy No", "autoWidth": true },
                            { "data": "FullNames", "title": "Full Name", "name": "Member", "autoWidth": true },
                            //{ "data": "EasyPayNo", "name": "EasyPayNo", "autoWidth": true },
                            //{ "data": "Cellphone", "name": "Cellphone", "autoWidth": true },
                            {
                                "data": "CoverDate", "name": "Coverdate", "autoWidth": true,
                                "render": function (data) {
                                    var date = new Date(parseInt(data.replace('/Date(', '')));
                                    return dateFormat(date, dateFormat.masks.isoDate, true);
                                }
                            },
                            {
                                "data": "PolicyStatus", "name": "Policy Status", "autoWidth": true,
                                "render": function (data, type, full, meta) {
                                    jQuery('.btn[href^=#]').click(function () {
                                        var href = jQuery(this).attr('href');
                                        jQuery(href).modal('toggle');
                                    })
                                    var data1 = JSON.stringify(full);
                                    data1 = data1.replace(/"/g, "\'")
                                    if ('@ViewBag.AdministratorOrSuperUser' == "True")
                                        return '<a onclick = "UpdateStatus(' + data1 + ')">' + data + '</a>';
                                    else
                                        return data;

                                }
                            },
                            {
                                "render": function (data, type, full, meta) {
                                        var dom = "<div class='row'>";

                                            var editMemberUrl = '<div class="col-sm-4 text-center"><a href="@Url.Action("ManageMembers", "Members", null, Request.Url.Scheme)?pkiMemberID=' + full.pkiMemberID + '"><i class="fa fa-edit"></i></a></div>';
                                            dom = dom + editMemberUrl;

                                            var deleteMemberUrl = '<div class="col-sm-4 text-center"><a href="@Url.Action("ManageMembers", "Members", null, Request.Url.Scheme)?pkiMemberID=' + full.pkiMemberID + '"><i class="fa fa-edit"></i>Make Payment</a></div>';
                                            dom = dom + deleteMemberUrl;


                                        dom = dom + "</div>";
                                        return dom;
                                }
                            }
                        ]
                    });

                @*var hasEditRights = '@(ViewBag.HasEditRight)';
                var hasDeleteRights = '@(ViewBag.HasDeleteRight)';
                hasEditRights = 'True';
                hasDeleteRights = 'True';

                var table = $('#memberDataTable');
                if (hasEditRights == 'True' || hasDeleteRights == 'True') {
                    table.DataTable().columns([7]).visible(true)
                }
                else {
                    table.DataTable().columns([7]).visible(false)
                }*@

                $('#PageSize').change(function () {
                    InitModel();
                    $('#memberDataTable').DataTable().page.len(model1.PageSize).draw();
                });

                $("#btnSearch").click(function () {
                    InitModel();
                    datatable.fnDraw();
                });
                function InitModel() {
                    model1.PageNum = 1;
                    //model1.CompanyId = $('#CompanyId').val();
                    //model1.BookID = $('#ddlBookName').val();

                    model1.PageSize = $('#PageSize').val();
                    model1.SarchText = $("#SarchText").val();
                    model1.StatusId = ($('#StatusId').val() == '' ? '0' : $('#StatusId').val());

                    $("#PageNum1").val(model1.PageNum);
                }
            }
        });
    </script>
}
<style>

    #memberPolicyDataTable table.dataTable thead .sorting {
        background-image: none !important;
    }

        #memberPolicyDataTable table.dataTable thead .sorting:after {
            content: none !important;
            float: right;
            font-family: fontawesome;
            color: rgba(50, 50, 50, 0.5);
        }
</style>